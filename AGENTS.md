# AGENTS.md - Kumo Budget Project Guide

> This document helps AI agents understand the project structure, conventions, and common pitfalls.

---

## Project Overview

**Kumo Budget** is a full-stack financial tracking application built on Cloudflare Workers.

| Technology         | Purpose                                 |
| ------------------ | --------------------------------------- |
| React Router v7    | Full-stack framework (SSR + client)     |
| Cloudflare Workers | Serverless runtime                      |
| D1 (SQLite)        | Database                                |
| R2                 | Object storage (CSV uploads)            |
| Workers AI         | Tag suggestions                         |
| Drizzle ORM        | Database queries and migrations         |
| Kumo UI            | Cloudflare's internal component library |

---

## Critical Rules

### 1. ONLY Use Kumo Components

**Never use raw HTML or other component libraries when Kumo has an equivalent.**

```tsx
// ❌ WRONG
<select onChange={...}>
  <option value="a">A</option>
</select>

// ✅ CORRECT
<Select value={value} onValueChange={setValue} items={[{value: 'a', label: 'A'}]}>
  <Select.Option value="a">A</Select.Option>
</Select>
```

### 2. Kumo Select Requires `items` Prop

**The `items` prop is required for the trigger to display labels instead of raw values.**

```tsx
// ❌ WRONG - trigger shows "checking" instead of "Checking"
<Select value={type} onValueChange={setType}>
  <Select.Option value="checking">Checking</Select.Option>
</Select>

// ✅ CORRECT - trigger shows "Checking"
<Select
  value={type}
  onValueChange={setType}
  items={[{ value: 'checking', label: 'Checking' }]}
>
  <Select.Option value="checking">Checking</Select.Option>
</Select>
```

### 3. All IDs Are UUIDs (Strings)

**Never use `Number(params.id)` - all IDs are text/UUID.**

```tsx
// ❌ WRONG
const projectId = Number(params.id);
if (isNaN(projectId)) throw new Response('Invalid ID', { status: 400 });

// ✅ CORRECT
const projectId = params.id;
```

### 4. Generate UUIDs on Create

**Pass `id: crypto.randomUUID()` when creating records.**

```tsx
// ❌ WRONG - missing id
await accountQueries.create(db, { projectId, name, type, balance });

// ✅ CORRECT
await accountQueries.create(db, {
  id: crypto.randomUUID(),
  projectId,
  name,
  type,
  balance,
});
```

### 5. Use Schema-Derived Types

**Query functions use types like `User['id']`, `Project['id']` - not `string` or `number`.**

```tsx
// ❌ WRONG
async findById(db: Database, id: string): Promise<Project | undefined>

// ✅ CORRECT
async findById(db: Database, id: Project['id']): Promise<Project | undefined>
```

### 6. Never Call DB Directly from Routes

**All database operations go through the query layer.**

```tsx
// ❌ WRONG
const user = await db.select().from(users).where(eq(users.id, id)).get();

// ✅ CORRECT
const user = await userQueries.findById(db, id);
```

### 7. Kumo Table API

```tsx
// ✅ CORRECT structure
<Table>
  <Table.Header>
    <Table.Row>
      <Table.Head>Column</Table.Head> {/* NOT Table.HeaderCell */}
    </Table.Row>
  </Table.Header>
  <Table.Body>
    <Table.Row>
      <Table.Cell>Value</Table.Cell>
    </Table.Row>
  </Table.Body>
</Table>
```

### 8. Kumo Checkbox Uses `onCheckedChange`

```tsx
// ❌ WRONG
<Checkbox onChange={(e) => setChecked(e.target.checked)} />

// ✅ CORRECT
<Checkbox checked={checked} onCheckedChange={(checked) => setChecked(checked)} />
```

### 9. Don't Use className on Kumo Text

```tsx
// ❌ WRONG
<Text className="mb-4">Hello</Text>

// ✅ CORRECT
<div className="mb-4">
  <Text>Hello</Text>
</div>
```

---

## Project Structure

```
kumo-budget/
├── app/
│   ├── components/          # Shared components (AppShell)
│   ├── lib/
│   │   ├── auth/            # Authentication (sessions, passwords, project-access)
│   │   ├── db/
│   │   │   ├── schema.ts    # Drizzle schema (source of truth for types)
│   │   │   ├── index.ts     # Database connection
│   │   │   └── queries/     # Query layer (accounts, projects, users, etc.)
│   │   └── config.ts        # App configuration
│   ├── routes/              # React Router routes
│   └── routes.ts            # Route configuration
├── drizzle/
│   └── migrations/          # SQL migrations (generated by drizzle-kit)
├── scripts/
│   └── seed.ts              # Database seeding script
└── wrangler.jsonc           # Cloudflare Workers config
```

---

## Database Schema

All tables use UUID primary keys (`text('id').primaryKey()`).

| Table             | Purpose                                      |
| ----------------- | -------------------------------------------- |
| users             | User accounts                                |
| sessions          | Active sessions (auth)                       |
| projects          | Budget projects (hierarchical)               |
| project_members   | User-project membership with roles           |
| accounts          | Financial accounts (checking, savings, etc.) |
| transactions      | Income/expense entries                       |
| tags              | Project-scoped labels                        |
| transaction_tags  | Many-to-many join                            |
| import_batches    | CSV import state tracking                    |
| import_batch_rows | Temp storage during import review            |

### Roles

- `owner` - Full access, can manage members
- `editor` - Can create/edit content
- `viewer` - Read-only access

---

## Common Tasks

### Adding a New Route

1. Create the route file in `app/routes/`
2. Add to `app/routes.ts`
3. Use `requireAuth` for protected routes
4. Use `requireProjectAccess` for project-scoped routes

```tsx
export async function loader({ request, context, params }: Route.LoaderArgs) {
  const { user } = await requireAuth(request, context.cloudflare.env);
  const db = createDb(context.cloudflare.env.DB);

  const projectId = params.id;
  await requireProjectAccess(db, user.id, projectId, 'editor');

  // ... rest of loader
}
```

### Adding a New Query Function

1. Add to appropriate file in `app/lib/db/queries/`
2. Use schema-derived types for IDs
3. Export from `app/lib/db/queries/index.ts`

```tsx
async findByProject(db: Database, projectId: Project['id']): Promise<Account[]> {
  return db.select().from(accounts).where(eq(accounts.projectId, projectId)).all();
}
```

### Running Database Migrations

```bash
# Generate migration from schema changes
npm run db:generate

# Apply migrations locally
npm run db:migrate

# Apply migrations to production
npm run db:migrate:prod

# Seed database (generates SQL, pipe to wrangler)
npm run db:seed
```

### Development

```bash
npm run dev      # Start dev server
npm run build    # Build for production
npm run deploy   # Deploy to Cloudflare
```

---

## Known Issues

### 1. Node Version / Vite crypto.hash Error

If you see `TypeError: crypto.hash is not a function` during build, it's a Node version incompatibility with Vite. The type checker (`npx tsc --noEmit`) still works.

### 2. Pre-commit Hooks

The project uses husky + lint-staged. Commits will fail if:

- ESLint errors exist (warnings are OK)
- Unused imports/variables
- Unnecessary `String()` conversions on strings

### 3. Kumo Component Discovery

Kumo is Cloudflare's internal library. Check existing usage in codebase for patterns. Key components:

- `Text`, `Button`, `Input`, `Select`, `Checkbox`
- `Table` (with `.Header`, `.Head`, `.Row`, `.Body`, `.Cell`)
- `Surface`, `Grid`, `GridItem`
- `Breadcrumbs` (with `.Link`, `.Separator`, `.Current`)
- `Banner` (with `BannerVariant.ERROR`, `.ALERT`, `.DEFAULT`)
- `Empty` (for empty states)
- `Badge`

---

## Environment & Bindings

Defined in `wrangler.jsonc`:

| Binding | Type       | Purpose          |
| ------- | ---------- | ---------------- |
| DB      | D1         | SQLite database  |
| BUCKET  | R2         | CSV file storage |
| AI      | Workers AI | Tag suggestions  |

Access via `context.cloudflare.env.DB`, etc.

---

## Git Workflow

- Main branch: `main`
- Remote: `git@github.com:CameronWhiteside/kumo-budget.git`
- Commit messages: Conventional commits (`feat:`, `fix:`, `refactor:`)

---

## Quick Reference

### Auth Helpers

```tsx
import { requireAuth, createSession, createSessionCookie } from '~/lib/auth';
import { requireProjectAccess, canEdit } from '~/lib/auth/project-access';
```

### Database

```tsx
import { createDb } from '~/lib/db';
import { userQueries, projectQueries, accountQueries, ... } from '~/lib/db/queries';
```

### Schema Types

```tsx
import type { User, Project, Account, Transaction, Tag, ... } from '~/lib/db/schema';
```

---

_Last Updated: 2026-02-14_
